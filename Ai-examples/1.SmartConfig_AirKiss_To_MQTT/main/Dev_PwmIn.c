/* pwm example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/

#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "freertos/queue.h"

#include "esp_log.h"
#include "esp_system.h"
#include "esp_err.h"

#include "esp8266/gpio_register.h"
#include "esp8266/pin_mux_register.h"

#include "driver/gpio.h"
#include "Dev_PwmIn.h"

#if (USE_PWM_PPM == RC_PWM_IN)

static const char *TAG = "Dev_PwmIn";

//#define PPM_IN_PIN  GPIO_Pin_5
#define GPIO_INPUT_IO_0     13
#define GPIO_INPUT_IO_1     12
#define GPIO_INPUT_IO_2     14
#define GPIO_INPUT_IO_3     4
#define GPIO_INPUT_IO_4     5

#define GPIO_INPUT_PIN_SEL  ((1ULL<<GPIO_INPUT_IO_0) | (1ULL<<GPIO_INPUT_IO_1) | (1ULL<<GPIO_INPUT_IO_2) | (1ULL<<GPIO_INPUT_IO_3) | (1ULL<<GPIO_INPUT_IO_4))


Rc_t Rc;

/******************************************************************************
 * FunctionName : gpio_intr_handler
 * Description  : gpio interrupt callback funtion
 * Parameters   : void
 * Returns      : void
*******************************************************************************/
extern uint32_t esp_get_time(void);

static void gpio_0_isr_handler(void *arg)
{
    static uint32_t start_time = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    static uint32_t end_time = 0;


    if(gpio_get_level(GPIO_INPUT_IO_0) == 1)
    {
        start_time = esp_get_time();
    }else if(gpio_get_level(GPIO_INPUT_IO_0) == 0)
    {
        end_time = esp_get_time();
        Rc.RC_ch[0] = end_time - start_time;

        Rc.recv_time = esp_get_time();
    }

  //      GPIO_REG_WRITE( GPIO_STATUS_W1TC_ADDRESS, GPIO_INPUT_PIN_SEL); //clear interrupt mask
   //     _xt_isr_unmask(GPIO_INPUT_PIN_SEL); //Enable the GPIO interrupt
}
static void gpio_1_isr_handler(void *arg)
{
    static uint32_t start_time = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    static uint32_t end_time = 0;

    if(gpio_get_level(GPIO_INPUT_IO_1) == 1)
    {
        start_time = esp_get_time();
    }else if(gpio_get_level(GPIO_INPUT_IO_1) == 0)
    {
        end_time = esp_get_time();
        Rc.RC_ch[1] = end_time - start_time;

        Rc.recv_time = esp_get_time();
    }

  //      GPIO_REG_WRITE( GPIO_STATUS_W1TC_ADDRESS, GPIO_INPUT_PIN_SEL); //clear interrupt mask
   //     _xt_isr_unmask(GPIO_INPUT_PIN_SEL); //Enable the GPIO interrupt
}
static void gpio_2_isr_handler(void *arg)
{
    static uint32_t start_time = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    static uint32_t end_time = 0;

    if(gpio_get_level(GPIO_INPUT_IO_2) == 1)
    {
        start_time = esp_get_time();
    }else if(gpio_get_level(GPIO_INPUT_IO_2) == 0)
    {
        end_time = esp_get_time();
        Rc.RC_ch[2] = end_time - start_time;
        Rc.recv_time = esp_get_time();
    }

  //      GPIO_REG_WRITE( GPIO_STATUS_W1TC_ADDRESS, GPIO_INPUT_PIN_SEL); //clear interrupt mask
   //     _xt_isr_unmask(GPIO_INPUT_PIN_SEL); //Enable the GPIO interrupt
}
static void gpio_3_isr_handler(void *arg)
{
    static uint32_t start_time = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    static uint32_t end_time = 0;

    if(gpio_get_level(GPIO_INPUT_IO_3) == 1)
    {
        start_time = esp_get_time();
    }else if(gpio_get_level(GPIO_INPUT_IO_3) == 0)
    {
        end_time = esp_get_time();
        Rc.RC_ch[3] = end_time - start_time;
        Rc.recv_time = esp_get_time();
    }

  //      GPIO_REG_WRITE( GPIO_STATUS_W1TC_ADDRESS, GPIO_INPUT_PIN_SEL); //clear interrupt mask
   //     _xt_isr_unmask(GPIO_INPUT_PIN_SEL); //Enable the GPIO interrupt
}
static void gpio_4_isr_handler(void *arg)
{
    static uint32_t start_time = 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
    static uint32_t end_time = 0;

    if(gpio_get_level(GPIO_INPUT_IO_4) == 1)
    {
        start_time = esp_get_time();
    }else if(gpio_get_level(GPIO_INPUT_IO_4) == 0)
    {
        end_time = esp_get_time();
        Rc.RC_ch[4] = end_time - start_time;
        Rc.recv_time = esp_get_time();
    }

  //      GPIO_REG_WRITE( GPIO_STATUS_W1TC_ADDRESS, GPIO_INPUT_PIN_SEL); //clear interrupt mask
   //     _xt_isr_unmask(GPIO_INPUT_PIN_SEL); //Enable the GPIO interrupt
}



static void GpioInputeConfig(void)
{
    gpio_config_t io_conf;    //Define GPIO Init Structure
    io_conf.intr_type = GPIO_INTR_ANYEDGE;
    //bit mask of the pins, use GPIO here
    io_conf.pin_bit_mask = GPIO_INPUT_PIN_SEL;
    //set as input mode
    io_conf.mode = GPIO_MODE_INPUT;
    //enable pull-up mode
    io_conf.pull_up_en = GPIO_PULLUP_ENABLE;

    io_conf.pull_down_en = GPIO_PULLDOWN_DISABLE;
    gpio_config(&io_conf);

    //change gpio intrrupt type for one pin
    //gpio_set_intr_type(GPIO_INPUT_IO_0, GPIO_INTR_ANYEDGE);

    //install gpio isr service
    gpio_install_isr_service(0);
    //hook isr handler for specific gpio pin again
    gpio_isr_handler_add(GPIO_INPUT_IO_0, gpio_0_isr_handler, (void *) GPIO_INPUT_IO_0);
    gpio_isr_handler_add(GPIO_INPUT_IO_1, gpio_1_isr_handler, (void *) GPIO_INPUT_IO_1);
    gpio_isr_handler_add(GPIO_INPUT_IO_2, gpio_2_isr_handler, (void *) GPIO_INPUT_IO_2);
    gpio_isr_handler_add(GPIO_INPUT_IO_3, gpio_3_isr_handler, (void *) GPIO_INPUT_IO_3);
    gpio_isr_handler_add(GPIO_INPUT_IO_4, gpio_4_isr_handler, (void *) GPIO_INPUT_IO_4);
}

static void Task_Show_PwmIn(void *pvParameters) 
{
    while(1)
    {
        if(esp_get_time() - Rc.recv_time > 2000000)
        {
            ESP_LOGI(TAG, "RC_PPM lost 2s!!!!!!!!!!!!");
            Rc.ppm_lost = 1;
            memset(Rc.RC_ch,1500,10);
        }
        else
        {
            ESP_LOGI(TAG, "RC_ch= %d,%d,%d,%d,%d,%d,%d,%d,%d%d",Rc.RC_ch[0],Rc.RC_ch[1],Rc.RC_ch[2],Rc.RC_ch[3],Rc.RC_ch[4],Rc.RC_ch[5],Rc.RC_ch[6],Rc.RC_ch[7],Rc.RC_ch[8],Rc.RC_ch[9]);
        }
        vTaskDelay(200/portTICK_RATE_MS);
    }
}

void RcIn_Init()
{
    GpioInputeConfig();
    xTaskCreate(Task_Show_PwmIn, "Task_Show_PwmIn", 1024, NULL, 5, NULL);
}

#endif
